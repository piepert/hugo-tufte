<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
{{- partial "header.html" . -}}

<body>

    {{ block "main" . }}{{ end }}

    <!-- Load Katex, if necessary. -->
    <!-- {{ if or .Params.math .IsHome }} -->
    {{ partial "math.html" . }}
    <!-- {{ end }} -->

    <script>var startProductBarPos = -1;

        function findPosY(obj) {
            var curtop = 0;
            if (typeof (obj.offsetParent) != 'undefined' && obj.offsetParent) {
                while (obj.offsetParent) {
                    curtop += obj.offsetTop;
                    obj = obj.offsetParent;
                }
                curtop += obj.offsetTop;
            }
            else if (obj.y)
                curtop += obj.y;
            return curtop;
        }

        // Function to check if an element is in the viewport
        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= -1 &&
                rect.left >= -1 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        // Function to find the last heading element that is above the viewport
        function getLastAboveViewport(headings) {
            let lastAboveViewport = null;
            for (let heading of headings) {
                const rect = heading.getBoundingClientRect();
                if (rect.bottom < 0) {
                    lastAboveViewport = heading;
                }
            }
            return lastAboveViewport;
        }

        // Function to find the first visible heading element or the last one above the viewport
        function getFirstVisibleOrLastAboveViewportHeading() {
            const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');

            for (let heading of headings) {
                if (isInViewport(heading)) {
                    return heading;
                }
            }

            const lastAboveViewport = getLastAboveViewport(headings);
            if (lastAboveViewport) {
                return lastAboveViewport;
            }

            return null;
        }

        // Function to build a tree of headings with numbering
        function buildHeadingTree() {
            const headings = document.querySelectorAll('h2, h3, h4, h5, h6');
            const tree = [];
            const stack = [{ level: 1, numbering: '', children: tree }];

            headings.forEach(heading => {
                const level = parseInt(heading.tagName[1]);
                const node = { element: heading, numbering: '', children: [] };

                // Update the numbering based on the current stack
                let parent = stack[stack.length - 1];
                if (parent.level < level) {
                    parent = { level: level - 1, numbering: parent.numbering, children: parent.children };
                }
                while (parent.level >= level) {
                    stack.pop();
                    parent = stack[stack.length - 1];
                    if (!parent) break;
                }
                node.numbering = parent ? `${parent.numbering}${parent.children.length + 1}.` : '1.';

                // Push the current node onto the stack
                parent.children.push(node);
                stack.push({ level, numbering: node.numbering, children: node.children });
            });

            return tree;
        }

        // Function to draw the Table of Contents
        function drawToC(currentHeading, headingTree) {
            function createList(index, items) {
                const ul = document.createElement('ul');

                items.forEach(item => {
                    let li = document.createElement('li');
                    let contentElement = document.createElement("span")
                    contentElement.classList.add("h" + index)

                    contentElement.innerHTML = /* item.numbering + */ item.element.innerHTML;
                    contentElement.dataset.targetId = item.element.id;

                    let linkElement = document.createElement("a")
                    linkElement.style.textDecoration = "none";

                    if (item.element === currentHeading) {
                        linkElement.classList.add("active-section")
                    }

                    if (item.element.id) {
                        linkElement.href = "#" + item.element.id
                    }

                    linkElement.appendChild(contentElement)
                    li.appendChild(linkElement);

                    if (item.children.length > 0) {
                        li.appendChild(createList(index + 1, item.children));
                    }

                    ul.appendChild(li);
                });

                return ul;
            }

            const tocContainer = document.getElementsByClassName("js-toc")[0];
            tocContainer.innerHTML = '';
            tocContainer.appendChild(createList(2, headingTree));
            return tocContainer
        }

        window.addEventListener('load', () => {
            const headingTree = buildHeadingTree();
            const currentHeading = getFirstVisibleOrLastAboveViewportHeading();
            drawToC(currentHeading, headingTree);
        });


        // Get the navbar
        var navbar = document.getElementById("nav");
        var sticky = navbar.offsetTop;

        // Add the sticky class to the navbar when you reach its scroll position. Remove "sticky" when you leave the scroll position
        function makeNavBar() {
            console.log(window.pageYOffset >= sticky)
            if (window.pageYOffset >= sticky) {
                navbar.classList.add("sticky")
            } else {
                navbar.classList.remove("sticky");
            }
        }

        window.addEventListener('scroll', () => {
            const headingTree = buildHeadingTree();
            const currentHeading = getFirstVisibleOrLastAboveViewportHeading();
            drawToC(currentHeading, headingTree);



            makeNavBar()
        });
    </script>
</body>

</html>